<!DOCTYPE html>
<html lang="ru">
<head>
    <%- include('../partials/head') %>
    <link rel="stylesheet" href="/style/page/lecture.css">
    <title>–õ–µ–∫—Ü–∏—è - BilimHub</title>
</head>
<body>
    <%- include('../partials/header') %>

    <div class="lecture-container">
        <a href="#" class="back-button" onclick="history.back(); return false;">‚Üê –ù–∞–∑–∞–¥ –∫ –ª–µ–∫—Ü–∏—è–º</a>

        <div id="loading" class="loading">
            –ó–∞–≥—Ä—É–∑–∫–∞ –ª–µ–∫—Ü–∏–∏...
        </div>

        <div id="lecture-content" style="display: none;">
            <div class="lecture-header">
                <h1 class="lecture-title" id="lecture-title"></h1>
                <div class="lecture-meta">
                    <span id="lecture-duration"></span>
                    <span id="lecture-theme"></span>
                </div>
            </div>

            <div class="video-container" id="video-container" style="display: none;">
                <video id="lecture-video" controls style="width: 100%; border-radius: 8px;">
                    <source id="video-source" src="" type="video/mp4">
                    –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ
                </video>
            </div>

            <div class="content-container" id="content-container">
                <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –ª–µ–∫—Ü–∏–∏ -->
            </div>

            <div class="tests-section">
                <h2 class="tests-title">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>
                <div id="tests-list">
                    <!-- –¢–µ—Å—Ç—ã –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã -->
                </div>
            </div>
        </div>
    </div>

    <%- include('../partials/footer') %>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        const lectureId = window.location.pathname.split('/')[2];

        async function loadLecture() {
            try {
                const response = await fetch(`/api/lectures/${lectureId}`, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('–õ–µ–∫—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                }

                const data = await response.json();
                const { lecture, progress } = data;

                document.getElementById('loading').style.display = 'none';
                document.getElementById('lecture-content').style.display = 'block';

                // –ó–∞–≥–æ–ª–æ–≤–æ–∫
                document.getElementById('lecture-title').textContent = lecture.title;
                document.getElementById('lecture-duration').innerHTML = `‚è±Ô∏è ${lecture.duration || 15} –º–∏–Ω`;
                document.getElementById('lecture-theme').innerHTML = `üìö ${lecture.theme.title}`;

                // –í–∏–¥–µ–æ
                if (lecture.videoUrl) {
                    document.getElementById('video-container').style.display = 'block';
                    document.getElementById('video-source').src = lecture.videoUrl;
                    document.getElementById('lecture-video').load();
                }

                // –ö–æ–Ω—Ç–µ–Ω—Ç (Markdown)
                const contentHtml = marked.parse(lecture.content);
                document.getElementById('content-container').innerHTML = contentHtml;

                // –¢–µ—Å—Ç—ã
                loadTests(lecture.tests, progress);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–µ–∫—Ü–∏–∏:', error);
                document.getElementById('loading').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–µ–∫—Ü–∏–∏';
            }
        }

        function loadTests(tests, progress) {
            const testsList = document.getElementById('tests-list');
            testsList.innerHTML = '';

            if (!tests || tests.length === 0) {
                testsList.innerHTML = '<p style="text-align: center; color: #7f8c8d;">–¢–µ—Å—Ç—ã –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</p>';
                return;
            }

            tests.forEach(test => {
                const card = createTestCard(test, progress);
                testsList.appendChild(card);
            });
        }

        function createTestCard(test, progress) {
            const card = document.createElement('div');
            card.className = 'test-card';

            const score = test.testNumber === 1 ? progress.test1Score : progress.test2Score;
            const isPassed = score !== null && score >= test.passingScore;
            const isAvailable = test.testNumber === 1 || (progress.test1Score !== null && progress.test1Score < test.passingScore);

            let scoreHtml = '';
            if (score !== null) {
                const scoreClass = isPassed ? 'score-passed' : 'score-failed';
                scoreHtml = `<span class="test-score ${scoreClass}">${score}%</span>`;
            }

            const buttonClass = isAvailable ? 'primary' : 'secondary';
            const buttonText = score !== null 
                ? (isPassed ? '–ü—Ä–æ–π–¥–µ–Ω–æ ‚úì' : '–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞') 
                : '–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç';
            const buttonDisabled = !isAvailable || isPassed;

            card.innerHTML = `
                <div class="test-header">
                    <span class="test-number">–¢–µ—Å—Ç ${test.testNumber}</span>
                    ${scoreHtml}
                </div>
                <p style="color: #7f8c8d; margin-bottom: 1rem;">
                    –ü—Ä–æ—Ö–æ–¥–Ω–æ–π –±–∞–ª–ª: ${test.passingScore}% | –í—Ä–µ–º—è: ${test.timeLimit || 10} –º–∏–Ω
                </p>
                <button 
                    class="test-button ${buttonClass}" 
                    onclick="startTest(${test.id})"
                    ${buttonDisabled ? 'disabled' : ''}
                >
                    ${buttonText}
                </button>
            `;

            return card;
        }

        function startTest(testId) {
            window.location.href = `/tests/${testId}`;
        }

        loadLecture();
    </script>
</body>
</html>
