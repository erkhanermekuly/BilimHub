<!DOCTYPE html>
<html lang="ru">
<head>
    <%- include('../partials/head') %>
    <link rel="stylesheet" href="/style/page/test.css">
    <title><%= test.title %> - BilimHub</title>
</head>
<body>
    <%- include('../partials/header') %>

    <div class="test-container">
        <div class="test-header">
            <h1>üìù <%= test.title %></h1>
            <div class="test-info">
                <span class="info-item">‚è±Ô∏è –í—Ä–µ–º—è: <span id="timer">30:00</span></span>
                <span class="info-item">‚úì –ü—Ä–æ—Ö–æ–¥–Ω–æ–π –±–∞–ª–ª: <%= test.passingScore %>%</span>
                <span class="info-item">‚ùì –í–æ–ø—Ä–æ—Å–æ–≤: <%= test.questions.length %></span>
            </div>
        </div>

        <form id="test-form" class="test-form">
            <% test.questions.forEach((question, qIndex) => { %>
                <div class="question-block" data-question-id="<%= question.id %>">
                    <div class="question-header">
                        <h3 class="question-number">–í–æ–ø—Ä–æ—Å <%= qIndex + 1 %> (<%= question.points %> –±–∞–ª–ª–æ–≤)</h3>
                        <span class="question-type">
                            <%= question.type === 'multiple' ? '–ù–µ—Å–∫–æ–ª—å–∫–æ –æ—Ç–≤–µ—Ç–æ–≤' : '–û–¥–∏–Ω –æ—Ç–≤–µ—Ç' %>
                        </span>
                    </div>
                    
                    <p class="question-text"><%= question.question %></p>
                    
                    <div class="answers-list">
                        <% question.answers.forEach((answer, aIndex) => { %>
                            <% const inputType = question.type === 'multiple' ? 'checkbox' : 'radio'; %>
                            <% const inputName = 'question_' + question.id; %>
                            <label class="answer-item">
                                <input 
                                    type="<%= inputType %>" 
                                    name="<%= inputName %>" 
                                    value="<%= answer.id %>"
                                    class="answer-input"
                                >
                                <span class="answer-label"><%= answer.answer %></span>
                            </label>
                        <% }); %>
                    </div>
                </div>
            <% }); %>

            <div class="form-actions">
                <button type="button" class="cancel-button" onclick="window.history.back()">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è</button>
                <button type="submit" class="submit-button">‚úì –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç—ã</button>
            </div>
        </form>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ -->
    <div id="results-modal" class="modal">
        <div class="modal-content modal-results">
            <div class="modal-header">
                <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞</h2>
            </div>
            <div class="results-content">
                <div class="score-display" id="score-display"></div>
                <div class="results-details" id="results-details"></div>
                <div class="modal-actions">
                    <button class="action-button" onclick="window.location.href='<%= `/lectures/${test.lectureId}` %>'">
                        ‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ª–µ–∫—Ü–∏–∏
                    </button>
                </div>
            </div>
        </div>
    </div>

    <%- include('../partials/footer') %>

    <script>
        const testData = <%- JSON.stringify(test) %>;
        let timeRemaining = testData.timeLimit * 60 || 1800;
        
        function updateTimer() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timer').textContent = 
                `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            
            if (timeRemaining > 0) {
                timeRemaining--;
                setTimeout(updateTimer, 1000);
            } else {
                alert('–í—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ!');
                document.getElementById('test-form').submit();
            }
        }

        // –ó–∞–ø—É—Å–∫ —Ç–∞–π–º–µ—Ä–∞
        updateTimer();

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
        document.getElementById('test-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            // –°–æ–±–∏—Ä–∞–µ–º –æ—Ç–≤–µ—Ç—ã
            const answers = {};
            const questions = document.querySelectorAll('.question-block');

            questions.forEach(questionDiv => {
                const questionId = parseInt(questionDiv.dataset.questionId);
                const inputName = `question_${questionId}`;
                const inputs = document.querySelectorAll(`input[name="${inputName}"]:checked`);

                if (inputs.length > 0) {
                    answers[questionId] = Array.from(inputs).map(input => parseInt(input.value));
                } else {
                    answers[questionId] = [];
                }
            });

            try {
                const response = await fetch(`/api/tests/<%= test.id %>/submit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ answers })
                });

                if (!response.ok) {
                    const error = await response.json();
                    alert('–û—à–∏–±–∫–∞: ' + error.error);
                    return;
                }

                const result = await response.json();
                showResults(result);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ—Å—Ç–∞:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ç–µ—Å—Ç–∞');
            }
        });

        // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        function showResults(result) {
            const scoreDisplay = document.getElementById('score-display');
            const detailsDiv = document.getElementById('results-details');
            
            const passed = result.passed;
            const scorePercentage = result.score;
            const passingScore = result.passingScore;
            
            const statusEmoji = passed ? '‚úÖ' : '‚ùå';
            const statusText = passed ? '–¢–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω!' : '–¢–µ—Å—Ç –Ω–µ –ø—Ä–æ–π–¥–µ–Ω';
            const statusClass = passed ? 'passed' : 'failed';

            scoreDisplay.innerHTML = `
                <div class="score-result ${statusClass}">
                    <div class="status-emoji">${statusEmoji}</div>
                    <div class="status-text">${statusText}</div>
                    <div class="score-value">${scorePercentage}%</div>
                    <div class="score-info">–ü—Ä–æ—Ö–æ–¥–Ω–æ–π –±–∞–ª–ª: ${passingScore}%</div>
                </div>
            `;

            let detailsHtml = '<div class="results-breakdown">';
            
            if (result.results && Array.isArray(result.results)) {
                result.results.forEach((resultItem, index) => {
                    const question = testData.questions.find(q => q.id === resultItem.questionId);
                    const isCorrect = resultItem.isCorrect;
                    const icon = isCorrect ? '‚úÖ' : '‚ùå';
                    const className = isCorrect ? 'correct' : 'incorrect';

                    detailsHtml += `
                        <div class="result-item ${className}">
                            <div class="result-header">
                                <span class="result-icon">${icon}</span>
                                <span class="result-question">–í–æ–ø—Ä–æ—Å ${index + 1}</span>
                            </div>
                            <p class="result-question-text">${question?.question || '–í–æ–ø—Ä–æ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω'}</p>
                            ${!isCorrect ? `
                                <div class="correct-answer">
                                    <strong>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã:</strong>
                                    <ul>
                                        ${resultItem.correctAnswers.map(answerId => {
                                            const answer = question?.answers?.find(a => a.id === answerId);
                                            return '<li>' + (answer?.answer || '–û—Ç–≤–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω') + '</li>';
                                        }).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
            }

            if (result.needTest2) {
                detailsHtml += `
                    <div class="info-message">
                        üí° –í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ–π—Ç–∏ –¢–µ—Å—Ç 2 (–ø–µ—Ä–µ—ç–∫–∑–∞–º–µ–Ω) –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –±–∞–ª–ª–∞
                    </div>
                `;
            }

            detailsHtml += '</div>';
            detailsDiv.innerHTML = detailsHtml;

            // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            document.getElementById('results-modal').classList.add('active');
        }
    </script>
</body>
</html>
